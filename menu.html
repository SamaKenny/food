<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Men√∫ ‚Äî Pedido por WhatsApp</title>
<style>
  :root{
    --bg:#faf9f6;--paper:#ffffff;--ink:#111318;--muted:#686b73;--brand:#16a085;--line:#ece9e1;
    --radius:16px;--shadow:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  img{max-width:100%;display:block}

  header.hero{background: radial-gradient(1200px 480px at 20% -10%, #fff, #f6f3ec);border-bottom:1px solid var(--line)}
  .hero-inner{max-width:1200px;margin:0 auto;padding:26px 16px 18px;display:grid;gap:18px;grid-template-columns:1fr}
  @media(min-width:960px){.hero-inner{grid-template-columns:1.1fr .9fr;align-items:center}}
  .brand{display:flex;gap:14px;align-items:center}
  .logo{width:56px;height:56px;border-radius:14px;background:#fff;border:1px solid var(--line);display:grid;place-items:center;box-shadow:var(--shadow)}
  .logo span{font-size:30px}
  h1.title{margin:0;font-size:32px}
  .subtitle{color:var(--muted);margin:6px 0 0}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .badge{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  input,button,select,textarea{font:inherit;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;color:var(--ink)}
  button{cursor:pointer;border:none;background:var(--brand);color:#fff;font-weight:700;box-shadow:0 3px 0 rgba(0,0,0,.06)}
  button.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}

  .container{max-width:1200px;margin:18px auto;padding:0 16px}
  .layout{display:grid;grid-template-columns:1fr;gap:18px}
  @media(min-width:1100px){.layout{grid-template-columns:1.3fr .7fr}}

  /* GRID: 3 items per row on desktop */
  .grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}

  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;display:flex;flex-direction:column;gap:10px}
  .thumb{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#f4f4f4;aspect-ratio:4/3}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title-line{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .title-line h3{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef4f3;border:1px solid #dfe9e7}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .stepper{display:inline-grid;grid-template-columns:auto auto auto;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .stepper button{background:#fff;color:var(--ink);border:0;padding:6px 10px;min-width:36px}
  .stepper input{width:54px;text-align:center;border:0}
  .price{font-weight:800}

  .cart{position:sticky;top:16px;height:fit-content;background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
  .cart table{width:100%;border-collapse:collapse}
  .cart th,.cart td{border-bottom:1px dashed var(--line);padding:8px 0;text-align:left;font-size:14px}
  .cart tfoot td{font-weight:800}
  .cta{display:flex;gap:8px;flex-wrap:wrap}
  .small{font-size:12px}
  .pill{background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:999px;display:inline-flex;gap:8px;align-items:center}
  .hint{font-size:12px;color:#8a8e95}
  .error{margin:12px 0;padding:12px;border:1px solid #ffb4ab;background:#fff6f5;border-radius:12px;color:#8b2c24}

  /* Randomizer list (editable) */
  .sugg-row{display:flex;align-items:center;gap:10px;justify-content:space-between;border:1px dashed var(--line);border-radius:12px;padding:8px;background:#fff}
  .sugg-meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .sugg-controls{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<header class="hero">
  <div class="hero-inner">
    <div>
      <div class="brand">
        <div class="logo"><span>üçΩÔ∏è</span></div>
        <div>
          <h1 class="title">Men√∫ para tu evento</h1>
          <p class="subtitle">Elige tus platillos y env√≠anos tu pedido por WhatsApp.</p>
          <div class="badges">
            <span class="badge">Bandejas</span>
            <span class="badge">Pedido en 1 clic</span>
          </div>
        </div>
      </div>

      <div class="controls">
        <input id="search" placeholder="Buscar: pollo, lasa√±a, tilapia..." style="flex:1" />
        <select id="category">
          <option value="all">Todas las categor√≠as</option>
          <option value="Prote√≠nas">Prote√≠nas</option>
          <option value="Acompa√±amientos">Acompa√±amientos</option>
        </select>
        <button id="clear">Limpiar pedido</button>
      </div>

      <!-- RANDOMIZER CONTROLS -->
      <div class="controls" style="margin-top:8px">
        <label class="small">Personas</label>
        <input id="randPeople" type="number" min="1" value="3" style="width:90px"/>
        <label class="small">Semanas</label>
        <input id="randWeeks" type="number" min="1" value="2" style="width:90px"/>
        <label class="small" style="display:flex;align-items:center;gap:6px">
          <input id="randVeg" type="checkbox"/> Vegetariano
        </label>
        <label class="small">Precio m√≠n</label>
        <input id="randPriceMin" type="number" min="0" step="500" placeholder="0" style="width:110px"/>
        <label class="small">Precio m√°x</label>
        <input id="randPriceMax" type="number" min="0" step="500" placeholder="50000" style="width:110px"/>
        <button id="randBtn">Generar plan</button>
      </div>
      <p class="hint">* El randomizador filtra por porci√≥n (seg√∫n personas) y rango de precio; puedes editar la lista sugerida antes de agregarla al carrito.</p>
    </div>

    <div>
      <div class="thumb" style="width:100%;height:auto;aspect-ratio:16/10">
        <img alt="Ejemplo de presentaci√≥n" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMTIwMCcgaGVpZ2h0PSc3MDAnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+PGxpbmVhckdyYWRpZW50IGlkPSdnJyB4MT0nMCUnIHkxPScwJScgeDI9JzAlJyB5Mj0nMTAwJSc+PHN0b3Agb2Zmc2V0PScwJScgc3RvcC1jb2xvcj0nI2ZmZicvPjxzdG9wIG9mZnNldD0nMTAwJScgc3RvcC1jb2xvcj0nI2YzZjNmMycvPjwvbGluZWFyR3JhZGllbnQ+PHJlY3Qgd2lkdGg9JzEyMDAnIGhlaWdodD0nNzAwJyBmaWxsPSJ1cmwoI2cpIi8+PGNpcmNsZSBjeD0nMTAwJyBjeT0nMTAwJyByPSc4MCcgZmlsbD0nI2ZmZicgZmlsbC1vcGFjaXR5PScuNScvPjx0ZXh0IHg9JzYwJScgeT0nNTAlJyBmb250LXNpemU9JzQwcHgnIGZpbGw9JyM0NDQnIHRleHQtYW5jaG9yPSdtaWRkbGUnPkltYWdlbiBkZSBlamVtcGxvPC90ZXh0Pjwvc3ZnPg==" />
      </div>
      <p class="hint">* Imagen de ejemplo. Puedes cargar tus propias fotos desde tu hoja.</p>
    </div>
  </div>
</header>

<main class="container layout">
  <section>
    <div class="row" style="display:flex;gap:8px;align-items:center; margin-bottom:8px;">
      <span class="pill" id="countPill">Cargando men√∫‚Ä¶</span>
    </div>

    <!-- 3-COLUMN GRID -->
    <div class="grid" id="menuGrid" aria-live="polite"></div>

    <!-- RANDOMIZER SUGGESTIONS (editable) -->
    <div class="cart" id="suggestions" style="display:none; margin-top:12px;">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Lista sugerida (editable)</strong>
        <div>
          <button class="secondary" id="addAllBtn">Agregar todo al carrito</button>
          <button id="clearSuggBtn">Limpiar lista</button>
        </div>
      </div>
      <div id="suggList" class="sugg-list"></div>
    </div>

    <div id="errorBox" class="error" style="display:none"></div>
  </section>

  <aside class="cart" aria-labelledby="cartTitle">
    <h2 id="cartTitle" style="margin:0">Tu pedido</h2>
    <table id="cartTable">
      <thead><tr><th>√çtem</th><th>Cant.</th><th>Unit.</th><th>Subt.</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="3" style="text-align:right">Total</td><td id="grandTotal">‚Äî</td></tr></tfoot>
    </table>
    <label class="small" for="waPhone">WhatsApp (c√≥digo pa√≠s + n√∫mero)</label>
    <input id="waPhone" value="50688887777" />
    <label class="small" for="customerName">Nombre</label>
    <input id="customerName" placeholder="Tu nombre" />
    <label class="small" for="deliveryInfo">Direcci√≥n / notas</label>
    <textarea id="deliveryInfo" rows="2" placeholder="Direcci√≥n, fecha/hora, notas"></textarea>
    <div class="cta">
      <button class="secondary" id="copyMsgBtn">Copiar mensaje</button>
      <button id="sendWaBtn">Enviar pedido por WhatsApp</button>
    </div>
  </aside>
</main>

<footer>¬© 2025 ‚Äî Servicio de catering. Precios por bandeja. Disponibilidad sujeta a confirmaci√≥n.</footer>

<script>
/* ===== SETTINGS ===== */
const SHEET_CSV_BASE = "https://docs.google.com/spreadsheets/d/12l1eCDutdVCjC_d4SpaDdHrp9nUNBMhN7V9OuCWFXsw/gviz/tq?tqx=out:csv";

/* ===== CSV Parser (maneja comillas, comas, saltos) ===== */
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  const pushField=()=>{ row.push(field); field=''; };
  const pushRow=()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const ch = text[i++];
    if(ch === '"'){ if(inQuotes && text[i] === '"'){ field += '"'; i++; } else { inQuotes = !inQuotes; } continue; }
    if(!inQuotes && ch === ','){ pushField(); continue; }
    if(!inQuotes && ch === '\n'){ pushField(); pushRow(); continue; }
    if(!inQuotes && ch === '\r'){ continue; }
    field += ch;
  }
  if(field.length>0 || row.length>0){ pushField(); pushRow(); }
  const header = (rows.shift()||[]).map(h=>h.trim());
  return rows.map(r=>Object.fromEntries(header.map((h,i)=>[h, (r[i]||'').trim()])));
}

/* ===== Price parser: reads 'CRC ‚Ç°5,600' -> 5600 ===== */
function parsePriceField(val){
  if(val==null) return 0;
  const s = String(val);
  const digits = s.match(/\d+/g);
  if(!digits) return 0;
  return Number(digits.join(''));
}

/* ===== State & Elements ===== */
const state = { raw:[], items:[], cart:{}, suggestions:[] };
const els = {
  grid: document.getElementById('menuGrid'),
  count: document.getElementById('countPill'),
  error: document.getElementById('errorBox'),
  search: document.getElementById('search'),
  category: document.getElementById('category'),
  clear: document.getElementById('clear'),
  cartBody: document.querySelector('#cartTable tbody'),
  grand: document.getElementById('grandTotal'),
  waPhone: document.getElementById('waPhone'),
  sendBtn: document.getElementById('sendWaBtn'),
  copyBtn: document.getElementById('copyMsgBtn'),
  name: document.getElementById('customerName'),
  notes: document.getElementById('deliveryInfo'),
  // randomizer
  randBtn: document.getElementById('randBtn'),
  randPeople: document.getElementById('randPeople'),
  randWeeks: document.getElementById('randWeeks'),
  randVeg: document.getElementById('randVeg'),
  randMin: document.getElementById('randPriceMin'),
  randMax: document.getElementById('randPriceMax'),
  suggWrap: document.getElementById('suggestions'),
  suggList: document.getElementById('suggList'),
  addAll: document.getElementById('addAllBtn'),
  clearSugg: document.getElementById('clearSuggBtn'),
};

function fmtCRC(n){ return '‚Ç°'+Number(n).toLocaleString(undefined,{maximumFractionDigits:0}); }
function itemKey(name, category){ return (category||'')+'|'+(name||''); }
function portionFor(people){ if(people<=2) return '2p'; if(people<=4) return '4p'; return '6p'; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function isVeg(it){
  const t = (it.name+' '+(it.details||'')).toLowerCase();
  return /veg|vegetar|ensalada|palmito|papa|chayote|pl√°tano|platano|verdura|vegetal|arroz blanco|gallo pinto/.test(t);
}

/* ===== Group CSV rows into items with portions ===== */
function groupRows(rows){
  const map = new Map();
  for(const r of rows){
    const category = r.category || r.Category || r.categoria || r.Categor√≠a || '';
    const name = r.name || r.Nombre || r.plato || '';
    if(!name) continue;
    let p = (r.portion || r.Porci√≥n || r.porcion || r.Tama√±o || r.tamano || r.tama√±o || '').toString().toLowerCase();
    if(p==='2' || p==='2 personas') p='2p';
    if(p==='4' || p==='4 personas') p='4p';
    if(p==='6' || p==='6 personas') p='6p';
    if(!p) p='2p';
    const priceRaw = r.sell_price || r.precio || r.price || r.base_price || r.costo || r.base || 0;
    const price = parsePriceField(priceRaw);
    const details = r.details || r.descripcion || r.detalles || '';
    const photo = r.photo_url || r.foto || '';
    const enabled = String(r.enabled || r.habilitado || 'TRUE').toUpperCase()!=='FALSE';
    if(!enabled) continue;

    const key = itemKey(name, category);
    if(!map.has(key)) map.set(key,{ key, name, category, details, photo_url: photo, portions:{} });
    const it = map.get(key);
    if(!it.details && details) it.details = details;
    if(!it.photo_url && photo) it.photo_url = photo;
    it.portions[p] = price;
  }
  return Array.from(map.values());
}

/* ===== Render items (3-col grid) ===== */
function renderList(items){
  els.grid.innerHTML = items.map(it=>{
    const img = it.photo_url
      ? `<img alt="Foto de ${it.name}" src="${it.photo_url}">`
      : `<img alt="Foto de ${it.name}" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nNjAwJyBoZWlnaHQ9JzQyMCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJz48bGluZWFyR3JhZGllbnQgaWQ9J2cnIHgxPScwJScgeTE9JzAlJyB4Mj0nMCUnIHkyPScxMDAlJz48c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjZmZmJy8+PHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjZWVlJy8+PC9saW5lYXJHcmFkaWVudD48cmVjdCB3aWR0aD0nNjAwJyBoZWlnaHQ9JzQyMCcgZmlsbD0ndXJsKCNnKScvPjx0ZXh0IHg9JzUwJScgeT0nNTAlJyBmb250LXNpemU9JzIwcHgnIGZpbGw9JyM0NDQnIHRleHQtYW5jaG9yPSdtaWRkbGUnPkZvcm8gZGUgcGxhdGlsbG88L3RleHQ+PC9zdmc+">`;
    const portionOptions = Object.entries(it.portions)
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([p,_])=>`<option value="${p}">${p.toUpperCase()}</option>`).join('');
    const firstP = Object.keys(it.portions)[0];
    const firstPrice = it.portions[firstP] || 0;

    return `<div class="card" data-key="${it.key}">
      <div class="thumb">${img}</div>
      <div class="title-line"><h3>${it.name}</h3><span class="chip">${it.category||''}</span></div>
      <p class="muted" style="min-height:38px">${it.details||''}</p>
      <div class="row">
        <label class="muted" for="portion-${it.key}">Porciones</label>
        <select class="portion" id="portion-${it.key}">${portionOptions}</select>
      </div>
      <div class="row">
        <div class="price" data-price="${firstPrice}">${fmtCRC(firstPrice)}</div>
        <div class="stepper">
          <button class="dec" aria-label="Restar">‚àí</button>
          <input class="qty" type="number" min="0" value="0" />
          <button class="inc" aria-label="Sumar">+</button>
        </div>
      </div>
    </div>`;
  }).join('') || `<div class="error">No hay √≠tems para mostrar. Verifica la hoja de c√°lculo o los filtros.</div>`;

  // Wire events
  document.querySelectorAll('.card').forEach(card=>{
    const key = card.dataset.key;
    const it = state.items.find(x=>x.key===key);
    const portionSel = card.querySelector('.portion');
    const priceEl = card.querySelector('.price');
    const qtyInput = card.querySelector('.qty');
    const inc = card.querySelector('.inc');
    const dec = card.querySelector('.dec');

    const p0 = portionSel.value || Object.keys(it.portions)[0];
    priceEl.dataset.price = Number(it.portions[p0]||0);
    priceEl.textContent = fmtCRC(priceEl.dataset.price);

    portionSel.onchange = ()=>{
      const p = portionSel.value;
      const price = Number(it.portions[p]||0);
      priceEl.dataset.price = price;
      priceEl.textContent = fmtCRC(price);
      const qty = Number(qtyInput.value||0);
      if(qty>0){
        Object.keys(state.cart).filter(k=>k.startsWith(key+'|')).forEach(k=>delete state.cart[k]);
        state.cart[key+'|'+p] = {name: it.name, portion: p, qty, price};
        renderCart();
      }
    };

    function sync(qty){
      qty = Math.max(0, Number(qty||0));
      qtyInput.value = qty;
      const p = portionSel.value;
      const price = Number(priceEl.dataset.price||0);
      const cartKey = key+'|'+p;
      if(qty>0) state.cart[cartKey] = {name: it.name, portion: p, qty, price};
      else delete state.cart[cartKey];
      renderCart();
    }
    inc.onclick = ()=> sync(Number(qtyInput.value||0)+1);
    dec.onclick = ()=> sync(Number(qtyInput.value||0)-1);
    qtyInput.oninput = e=> sync(e.target.value);
  });

  els.count.textContent = items.length ? `${items.length} opciones` : 'Sin resultados';
}

function renderCart(){
  let total=0;
  const rows = Object.values(state.cart).map(entry=>{
    const sub = entry.qty*Number(entry.price); total+=sub;
    return `<tr><td>${entry.name} (${entry.portion.toUpperCase()})</td><td>${entry.qty}</td><td>${fmtCRC(entry.price)}</td><td>${fmtCRC(sub)}</td></tr>`;
  }).join('');
  els.cartBody.innerHTML = rows || `<tr><td colspan="4" class="small muted">Agrega platillos para ver aqu√≠ tu pedido.</td></tr>`;
  els.grand.textContent = total ? fmtCRC(total) : '‚Äî';
}

/* ===== Filters ===== */
function filteredItems(){
  const q = (els.search.value||'').toLowerCase();
  const cat = els.category.value||'all';
  return state.items.filter(it=>{
    const okCat = cat==='all' || it.category===cat;
    const okQ = !q || (it.name||'').toLowerCase().includes(q) || (it.details||'').toLowerCase().includes(q);
    return okCat && okQ;
  });
}
els.search.oninput = ()=> renderList(filteredItems());
els.category.onchange = ()=> renderList(filteredItems());
els.clear.onclick = ()=>{ state.cart={}; renderCart(); };

/* ===== WhatsApp ===== */
els.copyBtn.onclick = ()=>{
  const msg = buildMessage();
  if(!msg){ alert('Agrega platillos primero.'); return; }
  navigator.clipboard.writeText(msg).then(()=>alert('Mensaje copiado ‚úÖ'));
};
els.sendBtn.onclick = ()=>{
  const msg = buildMessage();
  if(!msg){ alert('Agrega platillos primero.'); return; }
  const phone = (els.waPhone.value || '').replace(/\D+/g,'');
  if(!phone){ alert('Ingresa un n√∫mero de WhatsApp.'); return; }
  window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(msg),'_blank','noopener');
};
function buildMessage(){
  const lines=[]; let total=0;
  Object.values(state.cart).forEach(e=>{ const sub = e.qty*e.price; total+=sub;
    lines.push(`‚Ä¢ ${e.qty} √ó ${e.name} (${e.portion.toUpperCase()}) ‚Äî ${fmtCRC(e.price)} c/u = ${fmtCRC(sub)}`); });
  if(!lines.length) return '';
  const name = els.name.value?.trim();
  const notes = els.notes.value?.trim();
  return ['Hola, quisiera realizar un pedido:', ...lines, 'Total: '+fmtCRC(total), name ? 'Nombre: '+name : null, notes ? 'Notas: '+notes : null].filter(Boolean).join('\n');
}

/* ===== Randomizer (editable list) ===== */
function buildSuggestions(){
  const people = Math.max(1, parseInt(els.randPeople.value||'3',10));
  const weeks = Math.max(1, parseInt(els.randWeeks.value||'1',10));
  const days = Math.min(weeks*7, 28);
  const vegOnly = !!els.randVeg.checked;
  const pmin = els.randMin.value ? Number(els.randMin.value) : 0;
  const pmax = els.randMax.value ? Number(els.randMax.value) : Infinity;
  const portion = portionFor(people);

  let pool = filteredItems();
  if(vegOnly) pool = pool.filter(isVeg);
  pool = pool.filter(it => {
    const price = Number(it.portions[portion]||0);
    return price>=pmin && price<=pmax;
  });
  if(!pool.length) return [];
  const picks = shuffle(pool.slice()).slice(0, Math.min(pool.length, days));
  return picks.map(it=>({
    key: it.key, name: it.name, portions: it.portions, portion, qty: 1,
    price: Number(it.portions[portion]||0)
  }));
}
function renderSuggestions(){
  els.suggWrap.style.display='block';
  if(!state.suggestions.length){
    els.suggList.innerHTML = `<div class="muted">No hay platos que cumplan ese filtro.</div>`;
    els.suggWrap.scrollIntoView({behavior:'smooth',block:'start'});
    return;
  }
  els.suggList.innerHTML = state.suggestions.map((s,idx)=>{
    const options = Object.keys(s.portions).sort((a,b)=>a.localeCompare(b))
      .map(p=>`<option value="${p}" ${p===s.portion?'selected':''}>${p.toUpperCase()}</option>`).join('');
    return `<div class="sugg-row" data-i="${idx}">
      <div class="sugg-meta">
        <strong>${s.name}</strong>
        <span class="muted">(${fmtCRC(s.price)})</span>
      </div>
      <div class="sugg-controls">
        <label class="small">Porciones</label>
        <select class="s-portion">${options}</select>
        <div class="stepper">
          <button class="s-dec" aria-label="Menos">‚àí</button>
          <input class="s-qty" type="number" min="0" value="${s.qty}" />
          <button class="s-inc" aria-label="M√°s">+</button>
        </div>
        <button class="secondary s-remove">Quitar</button>
      </div>
    </div>`;
  }).join('');
  // wire events
  els.suggList.querySelectorAll('.sugg-row').forEach(row=>{
    const i = Number(row.dataset.i);
    const s = state.suggestions[i];
    const sel = row.querySelector('.s-portion');
    const q = row.querySelector('.s-qty');
    const inc = row.querySelector('.s-inc');
    const dec = row.querySelector('.s-dec');
    const rm = row.querySelector('.s-remove');

    sel.onchange = ()=>{
      s.portion = sel.value;
      s.price = Number(s.portions[s.portion]||0);
      renderSuggestions(); // refresh price text
    };
    function sync(val){
      s.qty = Math.max(0, Number(val||0));
      q.value = s.qty;
    }
    inc.onclick = ()=> sync(s.qty+1);
    dec.onclick = ()=> sync(s.qty-1);
    q.oninput = e=> sync(e.target.value);
    rm.onclick = ()=>{
      state.suggestions.splice(i,1);
      renderSuggestions();
    };
  });
  els.suggWrap.scrollIntoView({behavior:'smooth',block:'start'});
}
els.randBtn.onclick = ()=>{
  state.suggestions = buildSuggestions();
  renderSuggestions();
};
els.addAll.onclick = ()=>{
  state.suggestions.forEach(s=>{
    if(s.qty>0){
      const cartKey = s.key+'|'+s.portion;
      const prev = state.cart[cartKey]?.qty||0;
      state.cart[cartKey] = {name: s.name, portion: s.portion, qty: prev + s.qty, price: s.price};
    }
  });
  renderCart();
};
els.clearSugg.onclick = ()=>{
  state.suggestions = [];
  renderSuggestions();
};

/* ===== Load latest data (no cache) ===== */
async function loadData(){
  try{
    const url = SHEET_CSV_BASE + '&_=' + Date.now();
    const res = await fetch(url, {cache:'no-store', headers:{'Cache-Control':'no-cache'}});
    const txt = await res.text();
    const rows = parseCSV(txt);
    state.raw = rows.slice();
    state.items = groupRows(rows);
    if(!state.items.length){
      els.error.style.display='block';
      els.error.innerHTML = "No se encontraron √≠tems en la hoja. Aseg√∫rate de tener columnas: <b>name</b>/<b>Nombre</b>/<b>plato</b>, <b>portion</b>/<b>Porci√≥n</b>/<b>porcion</b> y <b>sell_price</b>/<b>precio</b>.";
    } else {
      els.error.style.display='none';
    }
    renderList(state.items);
  } catch(e){
    console.error(e);
    els.error.style.display='block';
    els.error.textContent = "No se pudo cargar la hoja (¬øCSV publicado?).";
  }
}
loadData();
</script>
</body>
</html>
